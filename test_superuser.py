#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from src.models.user import User
from src.models.board import BoardUserRole
from src.api.dependencies.permissions import check_board_permissions
from src.api.v1.columns import check_board_access
from src.services.board_service import BoardService
from sqlalchemy.ext.asyncio import AsyncSession


async def test_superuser_permissions():
    """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–∫-–æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    class MockUser:
        def __init__(self, user_id: int, is_superuser: bool = False):
            self.id = user_id
            self.is_superuser = is_superuser
    
    class MockDB:
        pass
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    regular_user = MockUser(1, is_superuser=False)
    superuser = MockUser(2, is_superuser=True)
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    print("=" * 50)
    
    # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ check_board_permissions
    print("1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ check_board_permissions...")
    
    try:
        # –î–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å True –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
        result = await check_board_permissions(
            db=MockDB(),
            board_id=1,
            user_id=superuser.id,
            required_roles=[BoardUserRole.OWNER],
            user=superuser
        )
        print("   ‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    
    # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ get_user_role
    print("\n2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ get_user_role...")
    
    try:
        # –î–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å OWNER
        user_role = await BoardService.get_user_role(
            db=MockDB(),
            board_id=1,
            user_id=superuser.id,
            user=superuser
        )
        if user_role == BoardUserRole.OWNER:
            print("   ‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Ä–æ–ª—å OWNER")
        else:
            print(f"   ‚ùå –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Ä–æ–ª—å {user_role}, –æ–∂–∏–¥–∞–ª–∞—Å—å OWNER")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    
    try:
        # –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ —Ä–æ–ª–∏ –¥–æ–ª–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å None
        user_role = await BoardService.get_user_role(
            db=MockDB(),
            board_id=1,
            user_id=regular_user.id,
            user=regular_user
        )
        if user_role is None:
            print("   ‚úÖ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–æ—Å–∫–µ –ø–æ–ª—É—á–∏–ª None")
        else:
            print(f"   ‚ùå –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Ä–æ–ª—å {user_role}, –æ–∂–∏–¥–∞–ª—Å—è None")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–æ–ª–∏ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
    
    print("\n3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –≤ –∫–æ–¥–µ...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –Ω–∞–ø—Ä—è–º—É—é
    if superuser.is_superuser:
        print("   ‚úÖ –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    else:
        print("   ‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    if not regular_user.is_superuser:
        print("   ‚úÖ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    else:
        print("   ‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    print("\n4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –¥–æ—Å—Ç—É–ø–∞...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if superuser and superuser.is_superuser:
        print("   ‚úÖ –£—Å–ª–æ–≤–∏–µ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç")
    else:
        print("   ‚ùå –£—Å–ª–æ–≤–∏–µ –¥–ª—è —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not (regular_user and regular_user.is_superuser):
        print("   ‚úÖ –£—Å–ª–æ–≤–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç")
    else:
        print("   ‚ùå –£—Å–ª–æ–≤–∏–µ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç")
    
    print("\n" + "=" * 50)
    print("üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("\n–ò–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã:")
    print("1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è check_board_permissions")
    print("2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è check_board_access")
    print("3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è get_user_role - —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å OWNER")
    print("4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ—Å–æ–∫ (boards.py)")
    print("5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–µ–≥–æ–≤ (tags.py)")
    print("6. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–æ—Å–æ–∫ (board_permissions.py)")
    print("7. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (comments.py)")
    print("8. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã websocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (websockets.py)")
    print("9. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ get_all_boards –≤ BoardService")
    print("\n–¢–µ–ø–µ—Ä—å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:")
    print("‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç —Ä–æ–ª—å OWNER –Ω–∞ –í–°–ï–• –¥–æ—Å–∫–∞—Ö")
    print("‚Ä¢ –í–∏–¥—è—Ç –≤—Å–µ –¥–æ—Å–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ")
    print("‚Ä¢ –ú–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –ª—é–±—ã–µ –¥–æ—Å–∫–∏")
    print("‚Ä¢ –ú–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ª—é–±—ã–µ –¥–æ—Å–∫–∏")
    print("‚Ä¢ –†–∞–±–æ—Ç–∞—é—Ç —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ –Ω–∞ –ª—é–±—ã—Ö –¥–æ—Å–∫–∞—Ö")
    print("‚Ä¢ –†–∞–±–æ—Ç–∞—é—Ç —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ª—é–±—ã—Ö –¥–æ—Å–∫–∞—Ö")
    print("‚Ä¢ –†–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç –∏ —É–¥–∞–ª—è—é—Ç –ª—é–±—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏")
    print("‚Ä¢ –†–∞–±–æ—Ç–∞—é—Ç —Å —Ç–µ–≥–∞–º–∏ –Ω–∞ –ª—é–±—ã—Ö –¥–æ—Å–∫–∞—Ö")
    print("‚Ä¢ –ò–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É")


if __name__ == "__main__":
    asyncio.run(test_superuser_permissions()) 